name: Validate Published JSON

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  schedule:
    - cron: "30 7 * * *"

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate endpoints
        env:
          BASE_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        run: |
          files=(events.json restaurants.json config.json meta.json)
          for f in "${files[@]}"; do
            status=$(curl -s -w "%{http_code}" -o "/tmp/$f" "$BASE_URL/$f")
            if [ "$status" != "200" ]; then
              echo "Endpoint $BASE_URL/$f unavailable (status $status). If Pages is not published yet, deploy it first."
              exit 1
            fi
          done
          python - <<'PY'
import json, sys, pathlib
base = pathlib.Path("/tmp")
events = json.loads(base.joinpath("events.json").read_text())
restaurants = json.loads(base.joinpath("restaurants.json").read_text())
config = json.loads(base.joinpath("config.json").read_text())
meta = json.loads(base.joinpath("meta.json").read_text())

def check_list(name, data, required):
    if not isinstance(data, list):
        sys.exit(f"{name} is not a list")
    if not data:
        if not meta.get(name, {}).get("item_count"):
            sys.exit(f"{name} empty without meta explanation")
        return
    *items, last = data
    for field in required:
        if field not in items[0]:
            sys.exit(f"{name} missing field {field}")
    if "_meta" not in last:
        sys.exit(f"{name} missing meta sentinel")

check_list("events", events, ["title", "category", "date"])
check_list("restaurants", restaurants, ["name", "cuisine", "url"])
if "branding" not in config or "pairing_rules" not in config:
    sys.exit("config missing branding or pairing_rules")
print("Validation passed")
PY
